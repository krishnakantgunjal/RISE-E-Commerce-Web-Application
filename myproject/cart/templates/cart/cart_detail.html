{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="cart-container">

    <div class="cart-header">
        <h1>ðŸ›’ Your Shopping Cart</h1>
        <p>Review your items and proceed to checkout</p>
    </div>

    {% if cart_items %}
    <div class="cart-content">
        <!-- Cart Items -->
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item">
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="cart-item-image">

                <div class="cart-item-details">
                    <h3>{{ item.product.name }}</h3>
                    <p style="color: var(--text-muted); font-size: 14px;">{{ item.product.category.name }}</p>
                    <div class="cart-item-price">â‚¹{{ item.price }}</div>
                    <div class="cart-item-quantity"
                        style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        Quantity:
                        <a href="{% url 'cart:cart_decrement' item.product.id %}"
                            onclick="updateQuantity(event, this.href, {{ item.product.id }})"
                            style="text-decoration: none; width: 28px; height: 28px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #333; font-weight: bold; border: 1px solid #ddd;">-</a>
                        <span id="qty-{{ item.product.id }}"
                            style="min-width: 24px; text-align: center; font-weight: 600;">{{ item.quantity }}</span>
                        <a href="{% url 'cart:cart_add' item.product.id %}"
                            onclick="updateQuantity(event, this.href, {{ item.product.id }})"
                            style="text-decoration: none; width: 28px; height: 28px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #333; font-weight: bold; border: 1px solid #ddd;">+</a>
                    </div>
                </div>

                <div class="cart-item-actions">
                    <div class="cart-item-total" id="subtotal-{{ item.product.id }}">â‚¹{{ item.subtotal }}</div>
                    <a class="btn-remove" href="{% url 'cart:cart_remove' item.product.id %}">
                        Remove
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary">
            <h2>Order Summary</h2>

            <div class="summary-row">
                <span class="summary-label">Subtotal</span>
                <span class="summary-value">â‚¹{{ total }}</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">Shipping</span>
                <span class="summary-value">Free</span>
            </div>

            <div class="summary-row total">
                <span class="summary-label">Total</span>
                <span class="summary-value" id="cart-total-amount">â‚¹{{ total }}</span>
            </div>

            <a class="btn btn-primary checkout-btn" href="{% url 'orders:checkout' %}">
                Proceed to Checkout â†’
            </a>

            <a class="btn btn-outline checkout-btn" href="{% url 'home' %}">
                Continue Shopping
            </a>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <div class="empty-cart-icon">ðŸ›’</div>
        <h2>Your cart is empty</h2>
        <p>Looks like you haven't added anything to your cart yet</p>
        <a class="btn btn-primary" href="{% url 'home' %}">Start Shopping</a>
    </div>
    {% endif %}

</div>
<script>
    function updateQuantity(event, url, productId) {
        event.preventDefault();

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.removed) {
                        location.reload();
                    } else {
                        // Update Quantity
                        const qtyEl = document.getElementById('qty-' + productId);
                        if (qtyEl) qtyEl.innerText = data.quantity;

                        // Update Subtotal (if element exists)
                        const subtotalEl = document.getElementById('subtotal-' + productId);
                        if (subtotalEl && data.subtotal) subtotalEl.innerText = 'â‚¹' + data.subtotal.toFixed(1);

                        // Update Total
                        const totalEl = document.getElementById('cart-total-amount');
                        if (totalEl) totalEl.innerText = 'â‚¹' + data.total_amount.toFixed(1);

                        // Also update the summary subtotal if it exists (class summary-value typically, but let's grab the first one)
                        // Or just reload if we want perfection, but total is enough for now.
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(err => console.error('Error:', err));
    }
</script>
{% endblock %}