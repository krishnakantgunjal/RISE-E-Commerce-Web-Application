{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Sales Dashboard - RISE Admin{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-container {
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #417690;
    }

    .stat-card.revenue {
        border-left-color: #28a745;
    }

    .stat-card.orders {
        border-left-color: #17a2b8;
    }

    .stat-card.products {
        border-left-color: #ffc107;
    }

    .stat-card.alert {
        border-left-color: #dc3545;
    }

    .stat-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }

    .stat-sub {
        font-size: 13px;
        color: #999;
        margin-top: 5px;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin: 30px 0 15px;
        color: #333;
    }

    .table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .alert-table {
        width: 100%;
        border-collapse: collapse;
    }

    .alert-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .alert-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }

    .stock-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .stock-low {
        background: #fff3cd;
        color: #856404;
    }

    .stock-out {
        background: #f8d7da;
        color: #721c24;
    }

    .order-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
    }

    .status-pending {
        background: #ffc107;
    }

    .status-processing {
        background: #17a2b8;
    }

    .status-shipped {
        background: #007bff;
    }

    .status-delivered {
        background: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>üìä Sales Dashboard</h1>
    <p style="color: #666; margin-bottom: 30px;">Overview of your store's performance and key metrics</p>

    <!-- Revenue Stats -->
    <div class="stats-grid">
        <div class="stat-card revenue">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value">‚Çπ{{ total_revenue|floatformat:2 }}</div>
            <div class="stat-sub">All time</div>
        </div>

        <div class="stat-card revenue">
            <div class="stat-label">This Month</div>
            <div class="stat-value">‚Çπ{{ month_revenue|floatformat:2 }}</div>
            <div class="stat-sub">{{ month_orders }} orders</div>
        </div>

        <div class="stat-card revenue">
            <div class="stat-label">Today</div>
            <div class="stat-value">‚Çπ{{ today_revenue|floatformat:2 }}</div>
            <div class="stat-sub">{{ today_orders }} orders</div>
        </div>

        <div class="stat-card orders">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value">{{ total_orders }}</div>
            <div class="stat-sub">{{ pending_orders }} pending</div>
        </div>
    </div>

    <!-- Product & Inventory Stats -->
    <div class="stats-grid">
        <div class="stat-card products">
            <div class="stat-label">Total Products</div>
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-sub">{{ available_products }} available</div>
        </div>

        <div class="stat-card products">
            <div class="stat-label">Categories</div>
            <div class="stat-value">{{ total_categories }}</div>
        </div>

        <div class="stat-card alert">
            <div class="stat-label">Stock Alerts</div>
            <div class="stat-value">{{ low_stock_products|length }}</div>
            <div class="stat-sub">{{ out_of_stock_count }} out of stock</div>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 20px; color: #333;">üìà Order Status Distribution</h3>
            <div style="height: 300px;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 20px; color: #333;">üìÖ Sales Overview</h3>
            <div style="height: 300px;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Status Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusLabels = [];
        const statusData = [];
        const statusColors = [];

        {% for stat in status_breakdown %}
        statusLabels.push('{{ stat.status|title }}');
        statusData.push({{ stat.count }});

        // Dynamic Colors
        if ('{{ stat.status }}' === 'completed' || '{{ stat.status }}' === 'delivered') statusColors.push('#28a745'); // Green
        else if ('{{ stat.status }}' === 'pending') statusColors.push('#ffc107'); // Yellow
        else if ('{{ stat.status }}' === 'processing') statusColors.push('#17a2b8'); // Blue
        else if ('{{ stat.status }}' === 'cancelled') statusColors.push('#dc3545'); // Red
        else statusColors.push('#6c757d'); // Grey
        {% endfor %}

        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: statusColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });

        // Sales Chart (Revenue vs Orders)
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: ['Today', 'This Month', 'Total'],
                datasets: [{
                    label: 'Revenue (‚Çπ)',
                    data: [{{ today_revenue }}, {{ month_revenue }}, {{ total_revenue }}],
            backgroundColor: '#6366f1',
            borderRadius: 5
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
        });
    </script>

    <!-- Low Stock Alerts -->
    {% if low_stock_products %}
    <h2 class="section-title">‚ö†Ô∏è Low Stock Alerts</h2>
    <div class="table-container">
        <table class="alert-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Stock</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for product in low_stock_products %}
                <tr>
                    <td><strong>{{ product.name }}</strong></td>
                    <td>{{ product.category.name }}</td>
                    <td><strong>{{ product.stock }}</strong></td>
                    <td>
                        {% if product.stock == 0 %}
                        <span class="stock-badge stock-out">Out of Stock</span>
                        {% else %}
                        <span class="stock-badge stock-low">Low Stock</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Recent Orders -->
    <h2 class="section-title">üì¶ Recent Orders</h2>
    <div class="table-container">
        <table class="alert-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td><strong>#{{ order.id }}</strong></td>
                    <td>{{ order.full_name }}</td>
                    <td>‚Çπ{{ order.total_amount }}</td>
                    <td>
                        <span class="order-status status-{{ order.status }}">{{ order.status }}</span>
                    </td>
                    <td>{{ order.created_at|date:"M d, Y" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: #999; padding: 30px;">
                        No orders yet
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div
        style="margin-top: 30px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196f3; border-radius: 4px;">
        <strong>üí° Quick Actions:</strong><br>
        <a href="{% url 'admin:store_product_changelist' %}" style="margin-right: 15px;">Manage Products</a>
        <a href="{% url 'admin:orders_order_changelist' %}" style="margin-right: 15px;">View Orders</a>
        <a href="{% url 'admin:store_category_changelist' %}">Manage Categories</a>
    </div>
</div>
{% endblock %}