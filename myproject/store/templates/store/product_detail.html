{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="product-detail-container">

    <div class="product-detail-content">
        <!-- Product Image -->
        <div class="product-image">
            {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
            <div class="no-image">No Image Available</div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div class="product-info-section">
            <h1>{{ product.name }}</h1>

            <div class="product-meta">
                <span class="category-badge">{{ product.category.name }}</span>
                <span
                    class="stock-status {% if product.stock == 0 %}out-of-stock{% elif product.is_low_stock %}low-stock{% endif %}">
                    {% if product.stock == 0 %}
                    Out of Stock
                    {% elif product.is_low_stock %}
                    Only {{ product.stock }} left!
                    {% else %}
                    In Stock ({{ product.stock }})
                    {% endif %}
                </span>
            </div>

            <div class="price-section">
                <span class="price">‚Çπ{{ product.price }}</span>
            </div>

            <div class="description">
                <h3>Description</h3>
                <p>{{ product.description|default:"No description available." }}</p>
            </div>

            <div class="action-buttons">
                {% if product.stock > 0 %}
                <a href="{% url 'cart:cart_add' product.id %}" class="btn btn-primary btn-large">
                    üõí Add to Cart
                </a>
                {% else %}
                <button class="btn btn-outline btn-large" disabled>Out of Stock</button>
                {% endif %}

                {% if user.is_authenticated %}
                <a href="{% url 'accounts:add_to_wishlist' product.id %}" class="btn btn-outline">
                    üíù Add to Wishlist
                </a>
                {% endif %}
            </div>

            <div class="product-specs">
                <h3>Product Details</h3>
                <ul>
                    <li><strong>Category:</strong> {{ product.category.name }}</li>
                    <li><strong>Availability:</strong> {{ product.stock }} units</li>
                    <li><strong>Product ID:</strong> #{{ product.id }}</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Reviews & Ratings Section -->
    <div style="margin-top: 60px;">
        <h2 class="section-title">Customer Reviews</h2>

        <!-- Rating Summary -->
        <div
            style="background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 30px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; font-weight: 800; color: var(--brand-primary);">
                        {% if average_rating %}{{ average_rating|floatformat:1 }}{% else %}0.0{% endif %}
                    </div>
                    <div style="color: #ffc107; font-size: 24px; margin: 10px 0;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <div style="color: var(--text-muted); font-size: 14px;">Based on {{ review_count }} reviews</div>
                </div>

                {% if user.is_authenticated and not user_review %}
                <div style="flex: 1;">
                    <p style="margin-bottom: 15px; font-weight: 600;">Share your experience!</p>
                    <a href="#review-form" class="btn btn-primary">Write a Review</a>
                </div>
                {% elif not user.is_authenticated %}
                <div style="flex: 1;">
                    <p style="margin-bottom: 15px; color: var(--text-muted);">Please <a
                            href="{% url 'accounts:login' %}" style="color: var(--brand-primary);">login</a> to write a
                        review</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Review Form -->
        {% if user.is_authenticated and not user_review %}
        <div id="review-form"
            style="background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); margin-bottom: 30px;">
            <h3 style="margin-bottom: 20px;">Write Your Review</h3>
            <form method="POST">
                {% csrf_token %}
                {{ review_form.as_p }}
                <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
        </div>
        {% elif user_review %}
        <div
            style="background: #e7f3ff; padding: 20px; border-radius: var(--radius-md); margin-bottom: 30px; border-left: 4px solid #2196f3;">
            <strong>‚úì You have already reviewed this product</strong>
        </div>
        {% endif %}

        <!-- Reviews List -->
        {% if reviews %}
        <div style="background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
            <h3 style="margin-bottom: 25px;">All Reviews ({{ review_count }})</h3>
            {% for review in reviews %}
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <strong>{{ review.user.username }}</strong>
                    <span style="color: var(--text-muted); font-size: 14px;">{{ review.created_at|date:"M d, Y"
                        }}</span>
                </div>
                <div style="color: #ffc107; margin: 5px 0;">Rating: {{review.rating}}/5 ‚òÖ</div>
                <p style="color: var(--text-secondary); line-height: 1.6;">{{ review.comment }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div
            style="text-align: center; padding: 60px 20px; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
            <p style="font-size: 48px; margin-bottom: 15px;">üí¨</p>
            <h3 style="margin-bottom: 10px;">No reviews yet</h3>
            <p style="color: var(--text-muted);">Be the first to review this product!</p>
        </div>
        {% endif %}
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div style="margin-top: 60px;">
        <h2 class="section-title">You May Also Like</h2>
        <div class="product-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
            {% for related in related_products %}
            <div class="product-card">
                <a href="{% url 'product_detail' related.slug %}">
                    {% if related.image %}
                    <img src="{{ related.image.url }}" alt="{{ related.name }}" class="product-img">
                    {% else %}
                    <div class="no-image">No Image</div>
                    {% endif %}
                </a>

                <div class="product-info">
                    <h3>{{ related.name }}</h3>
                    <p class="price">‚Çπ{{ related.price }}</p>

                    <div class="product-buttons">
                        <a class="btn btn-outline" href="{% url 'product_detail' related.slug %}">
                            View
                        </a>
                        {% if related.stock > 0 %}
                        <a class="btn btn-primary" href="{% url 'cart:cart_add' related.id %}">
                            Add to Cart
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}