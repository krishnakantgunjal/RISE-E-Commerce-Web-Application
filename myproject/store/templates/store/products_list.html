{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="page-container">

    <!-- Page Header -->
    <div style="margin-bottom: 30px;">
        <h1 class="page-title">All Products</h1>
        <p style="color: var(--text-secondary); font-size: 16px;">
            Showing {{ total_products }} product{{ total_products|pluralize }}
            {% if search_query %} for "{{ search_query }}"{% endif %}
            {% if selected_category %} in {{ selected_category.name }}{% endif %}
        </p>
    </div>

    <!-- Filters & Search Bar -->
    <div class="filter-bar">
        <!-- Search -->
        <form method="GET" class="search-box" style="display: flex; gap: 8px;">
            <input type="text" name="search" placeholder="Search products..." value="{{ search_query }}"
                style="flex: 1; padding: 12px 18px; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 15px;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 24px;">Search</button>
            {% if search_query or selected_category or price_range or in_stock %}
            <a href="{% url 'products_list' %}" class="btn btn-outline">Clear All</a>
            {% endif %}
        </form>
    </div>

    <!-- Filter Pills -->
    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin: 20px 0;">
        <!-- Category Filter -->
        <div style="position: relative;">
            <select name="category" onchange="applyFilter('category', this.value)" class="filter-select">
                <option value="">All Collections</option>
                {% for category in categories %}
                {% if selected_category and selected_category.slug == category.slug %}
                <option value="{{ category.slug }}" selected>{{ category.name }}</option>
                {% else %}
                <option value="{{ category.slug }}">{{ category.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- Price Filter -->
        <select name="price" onchange="applyFilter('price', this.value)" class="filter-select">
            <option value="">All Prices</option>
            {% if price_range == 'under-5000' %}<option value="under-5000" selected>Under ‚Çπ5,000</option>{% else %}
            <option value="under-5000">Under ‚Çπ5,000</option>{% endif %}
            {% if price_range == '5000-10000' %}<option value="5000-10000" selected>‚Çπ5,000 - ‚Çπ10,000</option>{% else %}
            <option value="5000-10000">‚Çπ5,000 - ‚Çπ10,000</option>{% endif %}
            {% if price_range == 'above-10000' %}<option value="above-10000" selected>Above ‚Çπ10,000</option>{% else %}
            <option value="above-10000">Above ‚Çπ10,000</option>{% endif %}
        </select>

        <!-- Sort By -->
        <select name="sort" onchange="applyFilter('sort', this.value)" class="filter-select">
            {% if sort_by == 'newest' %}<option value="newest" selected>Newest First</option>{% else %}<option
                value="newest">Newest First</option>{% endif %}
            {% if sort_by == 'price-low' %}<option value="price-low" selected>Price: Low to High</option>{% else %}
            <option value="price-low">Price: Low to High</option>{% endif %}
            {% if sort_by == 'price-high' %}<option value="price-high" selected>Price: High to Low</option>{% else %}
            <option value="price-high">Price: High to Low</option>{% endif %}
            {% if sort_by == 'name' %}<option value="name" selected>Name: A-Z</option>{% else %}<option value="name">
                Name: A-Z</option>{% endif %}
        </select>

        <!-- Stock Filter -->
        <select name="in_stock" onchange="applyFilter('in_stock', this.value)" class="filter-select">
            <option value="">All Products</option>
            {% if in_stock == 'yes' %}<option value="yes" selected>In Stock Only</option>{% else %}<option value="yes">
                In Stock Only</option>{% endif %}
        </select>
    </div>

    <!-- Products Grid -->
    {% if products %}
    <div class="product-grid" id="products">
        {% for product in products %}
        <div class="product-card animate-fade-in">
            <a href="{% url 'product_detail' product.slug %}">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
                {% else %}
                <div class="no-image"
                    style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #999;">
                    No Image</div>
                {% endif %}
            </a>

            {% if product.stock == 0 %}
            <div class="badge" style="background: #dc2626;">Out of Stock</div>
            {% elif product.is_low_stock %}
            <div class="badge" style="background: #ffc107;">Low Stock</div>
            {% endif %}

            <div class="product-info">
                <h3>{{ product.name }}</h3>
                <p class="price">‚Çπ{{ product.price }}</p>

                <div class="product-buttons">
                    <a class="btn btn-outline" href="{% url 'product_detail' product.slug %}">
                        View Details
                    </a>

                    {% if product.stock > 0 %}
                    <a class="btn btn-primary" href="{% url 'cart:cart_add' product.id %}">
                        Add to Cart
                    </a>
                    {% else %}
                    <button class="btn btn-outline" disabled style="opacity: 0.5; cursor: not-allowed;">
                        Out of Stock
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p style="font-size: 60px; margin-bottom: 20px;">üîç</p>
        <h2>No products found</h2>
        <p>Try adjusting your filters or search query</p>
        <a href="{% url 'products_list' %}" class="btn btn-primary" style="margin-top: 20px;">Clear Filters</a>
    </div>
    {% endif %}

</div>

<script>
    function applyFilter(param, value) {
        const url = new URL(window.location);

        if (value) {
            url.searchParams.set(param, value);
        } else {
            url.searchParams.delete(param);
        }

        window.location.href = url.toString();
    }
</script>
{% endblock %}